<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>消息测试</title>

    <script>
        if (getCookie("token") != null) {
            var socket;
            if (window.WebSocket) {
                //第一个ws是协议，第二个ws是我们在pipeline.addLast(new WebSocketServerProtocolHandler("/ws")); 配置的
                socket = new WebSocket("ws://localhost:8899/msg");
                //当socket得到数据的时候调用，相当于channelRead0
                socket.onmessage = function (event) {
                    document.getElementById("content").value =
                        JSON.parse(event.data).num;
                }
                socket.onopen = function (ev) {
                    document.getElementById("content").value = "客户端连上了服务器";
                }
                socket.onclose = function (ev) {
                    document.getElementById("content").value = "客户端断开服务器";
                }
            } else {
                alert("当前浏览器不支持websocket程序");
            }

            function sendMsg() {
                if (socket && socket.readyState == WebSocket.OPEN) {
                    socket.send(getMessage(getCookie("token")));
                }
            }
        }

        function getCookie(key) {
            var arr1 = document.cookie.split("; ");//由于cookie是通过一个分号+空格的形式串联起来的，所以这里需要先按分号空格截断,变成[name=Jack,pwd=123456,age=22]数组类型；
            for (var i = 0; i < arr1.length; i++) {
                var arr2 = arr1[i].split("=");//通过=截断，把name=Jack截断成[name,Jack]数组；
                if (arr2[0] == key) {
                    return decodeURI(arr2[1]);
                }
            }
        }
    </script>
</head>
<body>
<input onclick="sendMsg()" type="button" value="发送"><br>
<textarea id="content"></textarea>
<script src="/res/js/message.js"></script>
</body>
</html>